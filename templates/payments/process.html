{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-5">
            <div class="card bg-dark border-secondary shadow-lg">
                <div class="card-header bg-transparent border-secondary text-center py-4">
                    <h4 class="text-white mb-0 fw-bold">Confirm Payment</h4>
                </div>
                <div class="card-body p-4">

                    <div class="d-flex justify-content-between mb-3 text-muted">
                        <span>Order ID:</span>
                        <span class="text-white">#{{ order.id }}</span>
                    </div>

                    <div class="d-flex justify-content-between mb-4 text-muted">
                        <span>Total Amount:</span>
                        <span class="text-primary fs-4 fw-bold">₹{{ order.total_amount }}</span>
                    </div>

                    <div class="alert alert-info bg-secondary bg-opacity-25 border-0 text-white small">
                        <i class="fa-solid fa-lock me-2"></i>
                        Payment is processed securely by Razorpay. We support UPI, Cards, and Netbanking.
                    </div>

                    <!-- Razorpay Button -->
                    <button id="rzp-button1" class="btn btn-primary w-100 py-3 fw-bold shadow-lg">
                        Pay ₹{{ order.total_amount }} Now
                    </button>

                </div>
                <div class="card-footer bg-transparent border-secondary text-center py-3">
                    <small class="text-muted">Powered by <span class="text-white fw-bold">Razorpay</span></small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Form for Verify Callback -->
<form action="{% url 'payments:verify' %}" method="POST" id="payment-form">
    {% csrf_token %}
    <input type="hidden" name="razorpay_order_id" id="razorpay_order_id">
    <input type="hidden" name="razorpay_payment_id" id="razorpay_payment_id">
    <input type="hidden" name="razorpay_signature" id="razorpay_signature">
</form>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
var options = {
    "key": "{{ razorpay_key_id }}",
    "amount": "{{ amount_in_paise }}",
    "currency": "INR",
    "name": "CaseHaven",
    "description": "Payment for Order #{{ order.id }}",
    "image": "https://cdn.iconscout.com/icon/free/png-256/razorpay-1649771-1399875.png",
    "order_id": "{{ razorpay_order_id }}",
    "handler": function (response){
        // Populate hidden form and submit to backend for verification
        document.getElementById('razorpay_order_id').value = response.razorpay_order_id;
        document.getElementById('razorpay_payment_id').value = response.razorpay_payment_id;
        document.getElementById('razorpay_signature').value = response.razorpay_signature;
        document.getElementById('payment-form').submit();
    },
    "prefill": {
        "email": "{{ user_email }}",
        "contact": "{{ user_contact }}"
    },
    "theme": {
        "color": "#667eea"
    },
    "modal": {
        "ondismiss": function(){
            alert('Payment cancelled. Your order remains pending.');
        }
    }
};

var rzp1 = new Razorpay(options);

document.getElementById('rzp-button1').onclick = function(e){
    rzp1.open();
    e.preventDefault();
}
</script>
{% endblock %}